# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/
$(document).on 'ready page:load', ->
  $("div.chart").each ->
    canvas = $("<canvas>").attr(width: $(this).attr('data-width'), height: $(this).attr('data-height'))

    ctx = canvas[0].getContext('2d')
    jsonData = JSON.parse($(this).text())

    chart = new Chart(ctx)

    min_per_point = 5
    total_data = Math.floor(24*60 / min_per_point)

    legends = []
    data = {}
    data.datasets = []

    #Cut the variables:
    variables = {}

    idx = 0

    label_generators =
      monthly: () ->
        data.labels = new Array(total_data)

        for x in [0..data.labels.length]
          data.labels[x] = ""

      weekly: () ->
        data.labels = new Array(total_data)

        for x in [0..data.labels.length]
          data.labels[x] = ""

      yearly: () ->
        data.labels = new Array(total_data)

        for x in [0..data.labels.length]
          data.labels[x] = ""

      tick: () ->
        data.labels = []

        start = new Date(jsonData.start_at)
        decal = start.getHours() * 60 + start.getMinutes()

        # We fix the offset with the min_per_point:
        decal = Math.floor(decal/min_per_point) * min_per_point

        for min in [0..total_data]
          min = (min * min_per_point) + decal

          minMod = min % 60
          hourMod = Math.floor(min / 60) % 24

          if minMod is 0
            data.labels.push "#{hourMod}"
          else
            data.labels.push ""

        data


    label_generators[$(this).attr('data-target')]()
    for name, content of jsonData.data
      format = jsonData.format.variables[name]
      console.log $(this).attr('data-target'), name
      continue unless format?

      legends.push $ """<li><span class="legend-color" style="background-color: #{format.color}"></span>
        <b>#{name}</b> - #{format.desc}</div>"""

      dataset = {}
      dataset.fillColor = format.color
      dataset.strokeColor = format.color

      dataset.data = content

      #dataset.data = dataset.data.reverse()
      data.datasets.push dataset
      idx = idx + 1


    switch(jsonData.format.type)
      when 'curve'
        new chart.Line(data, datasetFill: false, scaleShowLabels: true, animation:false, pointDot: no)

    legend = $("<ul class='graph-legend'></ul>").append(legends)
    $(this).empty().append canvas, legend

    #new Chart(ctx).Line(data,options);

###
{"format":{"type":"curve","variables":{"load_avg_1mn":{"desc":"Load average (1mn)","color":"#0000FF"},"load_avg_5mn":{"desc":"Load average (5mn)","color":"#00FF00"},"load_avg_15mn":{"desc":"Load average (15mn)","color":"#FF0000"}}},
"data":{"11:52":[0.83,0.44,0.3],"11:53":[0.34,0.37,0.28],"11:54":[0.16,0.32,0.27],"11:55":[0.1,0.28,0.26],"11:56":[0.1,0.24,0.25],"11:57":[0.25,0.26,0.25],"11:58":[0.14,0.23,0.24],"11:59":[0.27,0.25,0.24],"12:00":[0.54,0.33,0.27],"12:01":[0.25,0.28,0.26],"12:02":[0.12,0.24,0.24],"12:03":[0.08,0.21,0.23],"12:04":[0.16,0.22,0.23],"12:05":[0.1,0.19,0.22],"12:06":[0.22,0.21,0.23],"12:07":[0.15,0.2,0.22],"12:08":[0.19,0.2,0.22],"12:09":[0.14,0.18,0.22],"12:10":[0.18,0.19,0.22],"12:11":[0.26,0.22,0.23],"12:12":[0.13,0.19,0.22],"12:13":[0.09,0.17,0.21],"12:14":[0.2,0.19,0.22],"12:15":[0.29,0.22,0.23],"12:16":[0.29,0.22,0.23],"12:17":[0.11,0.18,0.22],"12:18":[0.07,0.16,0.21],"12:19":[0.26,0.19,0.22],"12:20":[0.25,0.2,0.22],"12:21":[0.17,0.18,0.22],"12:22":[0.11,0.17,0.21],"12:23":[0.41,0.24,0.23],"12:24":[0.28,0.24,0.23],"12:25":[0.15,0.21,0.22],"12:26":[0.22,0.22,0.23],"12:27":[0.25,0.23,0.23],"12:28":[0.22,0.22,0.23],"12:29":[0.08,0.18,0.21],"12:30":[0.09,0.17,0.21],"12:31":[0.19,0.2,0.22],"12:32":[0.07,0.16,0.21],"12:33":[0.08,0.15,0.2],"12:34":[0.03,0.12,0.19],"12:35":[0.01,0.1,0.18],"12:36":[0,0.08,0.17],"12:37":[0,0.07,0.16],"12:38":[0,0.05,0.14],"12:39":[0,0.04,0.13],"12:40":[0.04,0.05,0.13],"12:41":[0.01,0.04,0.13],"12:42":[0.01,0.04,0.12],"12:43":[0,0.03,0.12],"12:44":[0,0.02,0.11],"12:45":[0.12,0.05,0.11],"12:46":[0.1,0.06,0.11],"12:47":[0.21,0.09,0.12],"12:48":[0.23,0.12,0.13],"12:49":[0.12,0.11,0.13],"12:50":[0.34,0.2,0.16],"12:51":[0.14,0.18,0.16],"12:52":[0.05,0.15,0.15],"12:53":[0.02,0.12,0.13],"12:54":[0.08,0.11,0.13],"12:55":[0.11,0.12,0.14],"12:56":[0.08,0.11,0.13],"12:57":[0.03,0.09,0.13],"12:58":[0.06,0.09,0.13],"12:59":[0.02,0.08,0.12],"13:00":[0.05,0.07,0.12],"13:01":[0.05,0.07,0.12],"13:02":[0.02,0.06,0.11],"13:03":[0.11,0.08,0.12],"13:04":[0.04,0.07,0.11],"13:05":[0.05,0.07,0.11],"13:06":[0.02,0.06,0.11],"13:07":[0.01,0.05,0.1],"13:08":[0,0.04,0.09],"13:09":[0,0.03,0.09],"13:10":[0.04,0.04,0.09],"13:11":[0.01,0.04,0.08],"13:12":[0,0.03,0.08],"13:13":[0,0.02,0.07],"13:14":[0.04,0.03,0.07],"13:15":[0.06,0.04,0.07],"13:16":[0.08,0.05,0.07],"13:17":[0.03,0.04,0.06],"13:18":[0.01,0.04,0.06],"13:19":[0,0.03,0.05],"13:20":[0.22,0.1,0.07],"13:21":[0.12,0.09,0.07],"13:22":[0.09,0.09,0.07],"13:23":[0.03,0.08,0.07],"13:24":[0.01,0.06,0.06],"13:25":[0.31,0.15,0.09],"13:26":[0.11,0.13,0.09],"13:27":[0.1,0.12,0.09],"13:28":[0.46,0.22,0.12],"13:29":[0.2,0.19,0.12],"13:30":[0.2,0.21,0.13],"13:31":[0.13,0.2,0.13],"13:32":[0.05,0.16,0.13],"13:33":[0.02,0.13,0.12],"13:34":[0.04,0.12,0.12],"13:36":[0.05,0.12,0.12],"13:37":[0.19,0.15,0.14],"13:38":[0.07,0.13,0.13],"13:39":[0.03,0.1,0.12],"13:40":[0.08,0.11,0.13],"13:41":[0.03,0.09,0.12],"13:42":[0.05,0.09,0.12],"13:43":[0.02,0.07,0.12],"13:44":[0.17,0.13,0.13],"13:45":[0.14,0.12,0.13],"13:46":[0.1,0.11,0.13],"13:47":[0.07,0.11,0.13],"13:48":[0.13,0.12,0.14],"13:49":[0.05,0.1,0.13],"13:50":[0.16,0.11,0.13],"13:51":[0.06,0.09,0.13],"13:52":[0.02,0.07,0.12],"13:53":[0.01,0.06,0.12],"13:54":[0,0.05,0.11],"13:55":[0,0.04,0.1],"13:56":[0,0.04,0.1],"13:57":[0.06,0.04,0.1],"13:58":[0.07,0.05,0.1],"13:59":[0.03,0.04,0.09],"14:00":[0.17,0.07,0.1],"14:01":[0.18,0.11,0.11],"14:02":[0.06,0.09,0.11],"14:03":[0.02,0.07,0.1],"14:04":[0.04,0.07,0.1],"14:05":[0.02,0.06,0.09],"14:06":[0.01,0.05,0.09],"14:07":[0.05,0.05,0.09],"14:08":[0.02,0.04,0.08],"14:09":[0.04,0.05,0.08],"14:10":[0.06,0.05,0.08],"14:11":[0.02,0.04,0.08],"14:12":[0.04,0.05,0.07],"14:13":[0.02,0.04,0.07],"14:14":[0.34,0.15,0.11],"14:15":[0.13,0.12,0.1],"14:16":[0.26,0.16,0.12],"14:17":[0.09,0.13,0.11],"14:18":[0.07,0.12,0.11],"14:19":[0.03,0.1,0.1],"14:20":[0.07,0.1,0.1],"14:21":[0.03,0.08,0.1],"14:22":[0.09,0.08,0.1],"14:23":[0.14,0.11,0.11],"14:24":[0.09,0.1,0.11],"14:25":[0.14,0.12,0.11],"14:26":[0.05,0.09,0.11],"14:27":[0.02,0.08,0.1],"14:28":[0.01,0.06,0.09],"14:29":[0.18,0.12,0.11],"14:30":[0.19,0.13,0.12],"14:31":[0.07,0.11,0.11],"14:32":[0.03,0.09,0.11],"14:33":[0.08,0.09,0.11],"14:34":[0.14,0.1,0.11],"14:35":[0.16,0.11,0.12],"14:36":[0.06,0.09,0.11],"14:37":[0.02,0.07,0.1],"14:38":[0.01,0.06,0.1],"14:39":[0.19,0.1,0.11],"14:40":[0.19,0.11,0.11],"14:41":[0.45,0.19,0.14],"14:42":[0.58,0.26,0.17],"14:43":[0.28,0.24,0.17],"14:44":[0.16,0.21,0.16],"14:45":[0.27,0.22,0.16],"14:46":[0.32,0.24,0.17],"14:47":[0.12,0.2,0.16],"14:48":[0.66,0.32,0.2],"14:49":[0.34,0.29,0.2],"14:50":[0.41,0.32,0.22],"14:51":[0.19,0.27,0.21],"14:52":[0.23,0.27,0.21],"14:53":[0.31,0.28,0.22],"14:54":[0.31,0.29,0.23],"14:55":[0.67,0.41,0.28],"14:56":[0.28,0.35,0.26],"14:57":[0.18,0.32,0.26],"14:58":[0.21,0.3,0.26],"14:59":[0.48,0.37,0.28],"15:00":[0.31,0.33,0.27],"15:01":[0.24,0.32,0.27],"15:02":[0.38,0.35,0.29],"15:03":[0.14,0.29,0.27],"15:04":[0.18,0.27,0.26],"15:05":[0.17,0.25,0.26],"15:06":[0.35,0.28,0.27],"15:07":[0.48,0.32,0.28],"15:08":[0.51,0.35,0.3],"15:09":[0.75,0.43,0.33],"15:10":[0.81,0.52,0.36],"15:11":[0.35,0.44,0.34],"15:12":[0.23,0.39,0.33],"15:13":[0.26,0.38,0.33],"15:14":[0.45,0.41,0.34],"15:15":[0.16,0.33,0.32],"15:16":[0.06,0.27,0.3],"15:17":[0.08,0.24,0.29],"15:18":[0.03,0.2,0.27],"15:19":[0.05,0.17,0.26],"15:20":[0.07,0.17,0.25],"15:21":[0.03,0.14,0.23],"15:22":[0.01,0.11,0.22],"15:23":[0.04,0.11,0.21],"15:24":[0.22,0.15,0.22],"15:25":[0.13,0.13,0.22],"15:26":[0.05,0.11,0.2],"15:27":[0.02,0.09,0.19],"15:28":[0.01,0.07,0.18],"15:29":[0.39,0.18,0.21],"15:30":[0.5,0.25,0.23],"15:31":[0.3,0.24,0.23],"15:32":[0.26,0.23,0.23],"15:33":[0.36,0.27,0.24],"15:34":[0.26,0.26,0.24],"15:35":[0.33,0.28,0.24],"15:36":[0.66,0.39,0.28],"15:37":[0.79,0.44,0.31],"15:38":[0.33,0.38,0.29],"15:39":[0.22,0.34,0.29],"15:40":[0.08,0.28,0.27],"15:41":[0.15,0.27,0.27],"15:42":[0.05,0.22,0.25],"15:43":[0.11,0.21,0.24],"15:44":[0.13,0.2,0.24],"15:45":[0.11,0.18,0.23],"15:46":[0.16,0.2,0.23],"15:47":[0.06,0.16,0.22],"15:48":[0.07,0.15,0.21],"15:49":[0.09,0.15,0.21],"15:50":[0.19,0.17,0.21],"15:51":[0.1,0.15,0.21],"15:52":[0.11,0.15,0.21],"15:53":[0.04,0.12,0.19],"15:54":[0.02,0.1,0.18],"15:55":[0.1,0.11,0.18],"15:56":[0.29,0.16,0.19],"15:57":[0.26,0.16,0.19],"15:58":[0.09,0.13,0.18],"15:59":[0.21,0.16,0.19],"16:00":[0.47,0.27,0.22],"16:01":[0.45,0.29,0.24],"16:02":[0.54,0.32,0.25],"16:03":[0.37,0.32,0.25],"16:04":[0.29,0.31,0.25],"16:05":[0.11,0.25,0.23],"16:06":[0.17,0.24,0.23],"16:07":[0.19,0.23,0.23],"16:08":[0.59,0.31,0.25],"16:09":[0.36,0.31,0.26],"16:10":[0.33,0.31,0.26],"16:11":[0.16,0.27,0.25],"16:12":[0.2,0.27,0.25],"16:13":[0.33,0.28,0.25],"16:14":[0.21,0.26,0.24],"16:15":[0.16,0.24,0.24],"16:16":[0.28,0.26,0.24],"16:17":[0.18,0.24,0.23],"16:18":[0.18,0.23,0.23],"16:19":[0.17,0.21,0.22],"16:20":[0.11,0.19,0.22],"16:21":[0.16,0.19,0.22],"16:22":[0.09,0.17,0.21],"16:23":[0.14,0.17,0.21],"16:24":[0.14,0.18,0.21],"16:25":[0.26,0.19,0.22],"16:26":[0.29,0.22,0.23],"16:27":[0.48,0.27,0.24],"16:28":[0.36,0.28,0.25],"16:29":[0.59,0.35,0.27],"16:30":[0.26,0.3,0.26],"16:31":[0.32,0.31,0.26],"16:32":[0.34,0.31,0.27],"16:33":[0.38,0.32,0.27],"16:34":[0.41,0.34,0.28],"16:35":[0.37,0.35,0.29],"16:36":[0.44,0.36,0.3],"16:37":[0.26,0.33,0.29],"16:38":[0.23,0.31,0.29],"16:39":[0.22,0.3,0.29],"16:40":[0.32,0.32,0.3],"16:42":[0.2,0.29,0.29],"16:43":[0.15,0.27,0.29],"16:44":[0.28,0.28,0.29],"16:45":[0.64,0.36,0.32],"16:46":[1.08,0.54,0.38]}}
###
  #var data = {
  #labels : ["January","February","March","April","May","June","July"],
  #datasets : [
  #  {
  #    fillColor : "rgba(220,220,220,0.5)",
  #    strokeColor : "rgba(220,220,220,1)",
  #    pointColor : "rgba(220,220,220,1)",
  #    pointStrokeColor : "#fff",
  #    data : [65,59,90,81,56,55,40]
  #  },
  #  {
  #    fillColor : "rgba(151,187,205,0.5)",
  #    strokeColor : "rgba(151,187,205,1)",
  #    pointColor : "rgba(151,187,205,1)",
  #    pointStrokeColor : "#fff",
  #    data : [28,48,40,19,96,27,100]
  #  }
  #]
  #}